apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: simple
spec:
  timeouts:
    exec: 1m
  skipDelete: true
  steps:
  - name: Create HTTP server
    try:
    - apply:
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: simple-http-trigger-webook
            namespace: default
            labels:
              app: nginx
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: nginx
            template:
              metadata:
                labels:
                  app: nginx
              spec:
                containers:
                - name: nginx
                  image: nginx:latest
                  ports:
                  - containerPort: 80
    - apply:
        resource:
          apiVersion: v1
          kind: Service
          metadata:
            name: nginx-service
            namespace: default
          spec:
            type: NodePort
            selector:
              app: nginx
            ports:
              - protocol: TCP
                port: 8888
                targetPort: 80
    - assert:
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: simple-http-trigger-webook
            namespace: default
          status:
            readyReplicas: 1
  - name: Create http trigger
    try:
    - apply:
        resource:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: serverless-kube-watch-trigger-deployment-rolebinding
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: serverless-kube-watch-trigger-deployment-role
          subjects:
          - kind: ServiceAccount
            name: serverless-kube-watch-trigger-controller-manager
            namespace: serverless-kube-watch-trigger-system
    - apply:
        resource:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: serverless-kube-watch-trigger-deployment-role
          rules:
          - apiGroups:
            - "apps"
            resources:
            - deployments
            verbs:
            - get
            - list
            - watch
    - apply:
        resource:
          apiVersion: triggers.harikube.info/v1
          kind: HTTPTrigger
          metadata:
            name: minimal-httptrigger-example
          spec:
            resource:
              apiVersion: apps/v1
              kind: Deployment
            url:
              service:
                name: nginx-service
                namespace: default
                uri:
                  static: "/"
            method: GET
    - assert:
        resource:
          apiVersion: triggers.harikube.info/v1
          kind: HTTPTrigger
          metadata:
            name: minimal-httptrigger-example
          status:
            lastGeneration: 1
  - name: Validate webhook trigger  
    try:
    - patch:
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: serverless-kube-watch-trigger-controller-manager 
            namespace: serverless-kube-watch-trigger-system
            labels:
              trigger: change
    - sleep:
        duration: 5s
    - script:
        content: kubectl logs -l app=nginx | grep 'Go-http-client/1.1'
    